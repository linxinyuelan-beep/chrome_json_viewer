# JSON 对比功能需求文档

## 一、功能概述

为 JSON Formatter & Viewer Chrome 扩展增加 JSON 对比功能，允许用户在独立页面中对比两个 JSON 数据的差异。

## 二、功能入口

### 2.1 入口点设计
- **主入口**：Popup 界面新增"JSON 对比"按钮/标签页
- **快捷入口**：
  - JsonViewer 组件工具栏添加"与其他 JSON 对比"按钮
  - 历史记录中选择两个 JSON 项后，显示"对比选中项"按钮
  - 右键菜单添加"对比 JSON"选项
- **新页面**：创建独立的 `json-compare.html` 页面（类似现有的 `json-window.html`）

### 2.2 启动方式
1. 从 Popup 直接打开对比页面（空白状态）
2. 从 JsonViewer 携带当前 JSON 数据打开对比页面（预填充左侧）
3. 从历史记录选择两个 JSON 直接对比

## 三、核心功能需求

### 3.1 JSON 输入区域

#### 3.1.1 左右双栏布局
- 左右各一个输入区域，支持多行文本输入
- 可调整左右栏宽度比例（拖拽分隔条）
- 每个输入区域包含：
  - 标题/标签（可编辑，如："源 JSON"、"目标 JSON"）
  - 大型文本输入框（支持代码高亮）
  - 字符/行数统计
  - 工具栏

#### 3.1.2 输入方式
- 手动粘贴 JSON 文本
- 从剪贴板导入
- 从历史记录选择
- 从文件上传（.json 文件）
- 从当前页面提取（如果是从 JsonViewer 进入）

### 3.2 JSON 预处理功能

每个输入区域独立提供以下预处理选项：

#### 3.2.1 格式化选项
- **美化格式化**：自动缩进（2空格/4空格/Tab可选）
- **压缩/最小化**：移除所有空白和换行
- **验证 JSON**：检查语法是否正确，显示错误位置

#### 3.2.2 键处理选项
- **排序键（Sort Keys）**：
  - 按字母顺序升序排序所有键
  - 按字母顺序降序排序
  - 递归排序（包含嵌套对象）
- **键转换**：
  - 转换为驼峰命名（camelCase）
  - 转换为蛇形命名（snake_case）
  - 转换为短横线命名（kebab-case）

#### 3.2.3 值处理选项
- **类型转换**：
  - 字符串化所有值
  - 尝试类型推断（"123" → 123）
- **空值处理**：
  - 移除 null 值
  - 移除空字符串
  - 移除空对象 `{}`
  - 移除空数组 `[]`

#### 3.2.4 日期处理
- 自动识别并转换 Microsoft 日期格式（复用现有 `dateConverter.ts`）
- ISO 日期格式标准化

### 3.3 对比功能

#### 3.3.1 对比模式
- **逐字符对比**（Character-level diff）
- **逐行对比**（Line-level diff）
- **结构化对比**（Structure-level diff）：
  - 按 JSON 路径对比
  - 显示键的增删改
  - 显示值的变化

#### 3.3.2 差异可视化
- **颜色标记**：
  - 🟢 绿色：新增内容（仅在右侧存在）
  - 🔴 红色：删除内容（仅在左侧存在）
  - 🟡 黄色/橙色：修改内容（两侧都存在但值不同）
  - ⚪ 灰色/白色：相同内容
  
- **高亮方式**：
  - 整行背景色高亮
  - 内联差异高亮（在行内标记具体变化字符）
  - 行号区域标记

#### 3.3.3 差异导航
- **差异统计**：显示总计：X 处新增、Y 处删除、Z 处修改
- **快速跳转**：
  - "上一处差异"按钮
  - "下一处差异"按钮
  - 差异列表侧边栏（点击跳转到对应位置）
  - 键盘快捷键：F3/Shift+F3 或 Ctrl+↓/Ctrl+↑

#### 3.3.4 差异筛选
- 仅显示差异部分（隐藏相同部分）
- 仅显示特定类型差异（只看新增/只看删除/只看修改）
- 按路径筛选（如只对比某个特定字段）

### 3.4 高级功能

#### 3.4.1 忽略选项
- 忽略键顺序差异
- 忽略空格和格式差异
- 忽略特定键（用户自定义忽略列表）
- 忽略数据类型差异（如 "123" 等同于 123）
- 忽略大小写差异

#### 3.4.2 合并功能
- 采用左侧（使用源 JSON）
- 采用右侧（使用目标 JSON）
- 智能合并（保留两侧特有内容）
- 手动选择每处差异如何合并

#### 3.4.3 路径查询
- 显示当前光标位置的 JSON 路径
- 按 JSON Path 表达式查询特定节点
- 支持 JSONPath 语法（如 `$.users[0].name`）

## 四、用户界面设计

### 4.1 页面布局

```
+--------------------------------------------------------+
|  [标题] JSON 对比工具                     [最小化][关闭]  |
+--------------------------------------------------------+
|  [工具栏]                                               |
|  📋 导入  💾 保存  🔄 交换  ⚙️ 设置  📊 差异统计         |
+--------------------------------------------------------+
|                    |                                    |
|   左侧输入区域       |    右侧输入区域                      |
|   [标签: 源 JSON]   |    [标签: 目标 JSON]               |
|                    |                                    |
|   [工具栏]          |    [工具栏]                         |
|   ✨格式化 🔤排序    |    ✨格式化 🔤排序                   |
|                    |                                    |
|   [JSON 内容区]     |    [JSON 内容区]                    |
|   带语法高亮        |    带语法高亮                       |
|   带差异标记        |    带差异标记                       |
|                    |                                    |
+--------------------+------------------------------------+
|  [对比控制栏]                                           |
|  ⏮️ 上一差异  ⏭️ 下一差异  🔍 仅显示差异  📋 导出差异    |
+--------------------------------------------------------+
```

### 4.2 交互设计
- 同步滚动：左右两侧联动滚动（可选关闭）
- 折叠/展开：大型 JSON 支持节点折叠
- 快捷操作：双击差异行快速定位对应行
- 悬浮提示：鼠标悬停显示详细差异信息

## 五、技术实现建议

### 5.1 新增文件
- `src/json-compare.html` - 对比页面 HTML
- `src/json-compare.tsx` - 对比页面 React 主组件
- `src/components/JsonCompare.tsx` - 对比核心组件
- `src/components/JsonDiffViewer.tsx` - 差异可视化组件
- `src/utils/jsonDiff.ts` - JSON 差异计算工具
- `src/utils/jsonMerge.ts` - JSON 合并工具
- `src/assets/styles/json-compare.css` - 对比页面样式

### 5.2 复用现有组件
- `jsonParser.ts` - JSON 解析和验证
- `dateConverter.ts` - 日期格式转换
- `jsonHistory.ts` - 历史记录读取
- `i18n.ts` - 多语言支持

### 5.3 第三方库建议
- **差异算法**：
  - `diff` 或 `diff-match-patch` - 文本差异计算
  - `json-diff` 或 `deep-diff` - 结构化 JSON 差异
- **代码编辑器**：
  - `monaco-editor` - 强大的代码编辑器（VS Code 使用的编辑器）
  - 或继续使用 `@microlink/react-json-view`（需要自定义差异标记）
- **语法高亮**：
  - `prismjs` 或 `highlight.js`

### 5.4 Webpack 配置更新
```javascript
entry: {
    background: './src/background.ts',
    content: './src/content.ts',
    popup: './src/popup.tsx',
    'json-compare': './src/json-compare.tsx',  // 新增
}
```

## 六、数据持久化

### 6.1 保存对比会话
- 保存左右两侧的 JSON 数据
- 保存预处理选项配置
- 保存对比结果和标注

### 6.2 导出功能
- **导出对比报告**：HTML 格式带样式的差异报告
- **导出差异 JSON**：仅包含差异部分的 JSON
- **导出合并结果**：合并后的完整 JSON
- **导出补丁文件**：JSON Patch 格式（RFC 6902）

## 七、性能优化

### 7.1 大数据处理
- 虚拟滚动：大型 JSON 使用虚拟列表
- 延迟渲染：按需加载可见区域
- Web Worker：后台线程计算差异

### 7.2 响应优化
- 实时预览：输入时即时验证和高亮
- 防抖处理：避免频繁的差异计算
- 缓存机制：缓存差异计算结果

## 八、用户体验

### 8.1 快捷键
- `Ctrl/Cmd + V` - 粘贴到当前焦点区域
- `Ctrl/Cmd + S` - 保存/导出
- `Ctrl/Cmd + Alt + F` - 格式化当前 JSON
- `Ctrl/Cmd + Alt + K` - 排序键
- `F3` / `Shift + F3` - 下一个/上一个差异
- `Ctrl/Cmd + ↔` - 切换左右焦点

### 8.2 错误处理
- JSON 语法错误提示（行号、错误类型）
- 无法对比时的友好提示
- 数据过大时的警告

### 8.3 帮助文档
- 首次使用引导
- 功能说明悬浮提示
- 示例 JSON 快速开始

## 九、国际化

复用现有的 `i18n.ts`，添加对比功能相关的多语言文本：
- 中文（简体）
- 英文
- 其他语言支持

## 十、未来扩展

### 10.1 高级特性
- 三向对比（Base、Left、Right）
- JSON Schema 验证对比
- 自动生成变更日志
- AI 辅助差异分析

### 10.2 集成功能
- 与版本控制系统集成
- API 响应对比模式
- 配置文件对比模板

---

## 附录：用户故事

### 故事 1：API 调试
> 作为开发者，我想对比两次 API 调用的返回结果，以便发现接口变化

### 故事 2：配置迁移
> 作为运维人员，我想对比新旧配置文件，以便确保迁移时不遗漏设置

### 故事 3：数据验证
> 作为测试人员，我想对比预期结果和实际结果，以便验证数据处理的正确性

---

## 文档变更历史

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 1.0 | 2025-12-18 | - | 初始版本，定义核心需求 |
